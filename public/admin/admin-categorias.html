<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin - Categorías</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    form { margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    label { display: block; margin-top: 10px; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
    .actions button { margin-right: 5px; }
    a { text-decoration: none; color: #0d3b66; }
  </style>
</head>
<body>
  <h1>Administrar Categorías</h1>
  <p><a href="/admin/">← Volver al panel</a></p>

  <table id="tabla-categorias">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Se rellena por JS -->
    </tbody>
  </table>

  <h2 id="form-title">Crear / Editar Categoría</h2>
  <form id="form-categoria">
    <input type="hidden" id="cat-id">
    <label>Nombre</label>
    <input type="text" id="cat-nombre" required>

    <label>Descripción</label>
    <textarea id="cat-descripcion"></textarea>

    <label>Estado</label>
    <select id="cat-estado">
      <option value="activo">activo</option>
      <option value="inactivo">inactivo</option>
    </select>

    <button type="submit">Guardar</button>
    <button type="button" id="btn-cancelar">Cancelar</button>
  </form>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/auth.html';
    }

    const tablaBody = document.querySelector('#tabla-categorias tbody');
    const form = document.getElementById('form-categoria');
    const formTitle = document.getElementById('form-title');

    const inputId = document.getElementById('cat-id');
    const inputNombre = document.getElementById('cat-nombre');
    const inputDescripcion = document.getElementById('cat-descripcion');
    const selectEstado = document.getElementById('cat-estado');
    const btnCancelar = document.getElementById('btn-cancelar');

    async function cargarCategorias() {
      tablaBody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
      try {
        const res = await fetch('/api/categorias', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        if (!res.ok) throw new Error('Error al obtener categorías');
        const data = await res.json();
        renderTabla(data);
      } catch (e) {
        tablaBody.innerHTML = '<tr><td colspan="5">Error: ' + e.message + '</td></tr>';
      }
    }

    function renderTabla(categorias) {
      if (!categorias.length) {
        tablaBody.innerHTML = '<tr><td colspan="5">Sin registros</td></tr>';
        return;
      }

      tablaBody.innerHTML = '';
      categorias.forEach(cat => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cat.id}</td>
          <td>${cat.nombre}</td>
          <td>${cat.descripcion || ''}</td>
          <td>${cat.estado}</td>
          <td class="actions">
            <button type="button" data-id="${cat.id}" data-action="edit">Editar</button>
            <button type="button" data-id="${cat.id}" data-action="delete">Eliminar</button>
          </td>
        `;
        tablaBody.appendChild(tr);
      });
    }

    tablaBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (btn.tagName !== 'BUTTON') return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');

      if (action === 'edit') {
        editarCategoria(id);
      } else if (action === 'delete') {
        if (confirm('¿Eliminar esta categoría?')) {
          await eliminarCategoria(id);
          cargarCategorias();
        }
      }
    });

    async function editarCategoria(id) {
      const res = await fetch('/api/categorias/' + id, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) {
        alert('Error al obtener la categoría');
        return;
      }
      const cat = await res.json();
      inputId.value = cat.id;
      inputNombre.value = cat.nombre;
      inputDescripcion.value = cat.descripcion || '';
      selectEstado.value = cat.estado || 'activo';
      formTitle.textContent = 'Editar Categoría (ID ' + cat.id + ')';
    }

    async function eliminarCategoria(id) {
      const res = await fetch('/api/categorias/' + id, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert('Error al eliminar: ' + (data.error || res.statusText));
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = inputId.value;
      const payload = {
        nombre: inputNombre.value,
        descripcion: inputDescripcion.value,
        estado: selectEstado.value
      };

      const url = id ? '/api/categorias/' + id : '/api/categorias';
      const method = id ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        alert('Error al guardar: ' + (data.error || res.statusText));
      } else {
        alert('Guardado correctamente');
        limpiarFormulario();
        cargarCategorias();
      }
    });

    function limpiarFormulario() {
      inputId.value = '';
      inputNombre.value = '';
      inputDescripcion.value = '';
      selectEstado.value = 'activo';
      formTitle.textContent = 'Crear / Editar Categoría';
    }

    btnCancelar.addEventListener('click', () => {
      limpiarFormulario();
    });

    cargarCategorias();
  </script>
</body>
</html>
