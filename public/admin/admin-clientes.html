<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin - Clientes / Usuarios</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    form { margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
    .actions button { margin-right: 5px; }
    a { text-decoration: none; color: #0d3b66; }
  </style>
</head>
<body>
  <h1>Administrar Clientes / Usuarios</h1>
  <p><a href="/admin/">← Volver al panel</a></p>

  <table id="tabla-usuarios">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Rol</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- JS -->
    </tbody>
  </table>

  <h2 id="form-title">Crear / Editar Usuario</h2>
  <form id="form-usuario">
    <input type="hidden" id="usr-id">

    <label>Nombre</label>
    <input type="text" id="usr-nombre" required>

    <label>Email</label>
    <input type="email" id="usr-email" required>

    <label>Rol</label>
    <select id="usr-rol">
      <option value="USER">CLIENTE</option>
      <option value="ADMIN">ADMIN</option>
    </select>

    <label>Estado</label>
    <select id="usr-estado">
      <option value="activo">activo</option>
      <option value="inactivo">inactivo</option>
    </select>

    <label>Contraseña (solo si quieres crear o cambiar)</label>
    <input type="password" id="usr-password">

    <button type="submit">Guardar</button>
    <button type="button" id="btn-cancelar">Cancelar</button>
  </form>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/auth.html';
    }

    const tablaBody = document.querySelector('#tabla-usuarios tbody');
    const form = document.getElementById('form-usuario');
    const formTitle = document.getElementById('form-title');

    const inputId = document.getElementById('usr-id');
    const inputNombre = document.getElementById('usr-nombre');
    const inputEmail = document.getElementById('usr-email');
    const selectRol = document.getElementById('usr-rol');
    const selectEstado = document.getElementById('usr-estado');
    const inputPassword = document.getElementById('usr-password');
    const btnCancelar = document.getElementById('btn-cancelar');

    async function cargarUsuarios() {
      tablaBody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
      try {
        const res = await fetch('/api/usuarios', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        if (!res.ok) throw new Error('Error al obtener usuarios');
        const data = await res.json();
        renderTabla(data);
      } catch (e) {
        tablaBody.innerHTML = '<tr><td colspan="7">Error: ' + e.message + '</td></tr>';
      }
    }

    function renderTabla(usuarios) {
      if (!usuarios.length) {
        tablaBody.innerHTML = '<tr><td colspan="7">Sin registros</td></tr>';
        return;
      }

      tablaBody.innerHTML = '';
      usuarios.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.nombre}</td>
          <td>${u.email}</td>
          <td>${u.rol}</td>
          <td>${u.estado}</td>
          <td class="actions">
            <button type="button" data-id="${u.id}" data-action="edit">Editar</button>
            <button type="button" data-id="${u.id}" data-action="delete">Eliminar</button>
          </td>
        `;
        tablaBody.appendChild(tr);
      });
    }

    tablaBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (btn.tagName !== 'BUTTON') return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');

      if (action === 'edit') {
        editarUsuario(id);
      } else if (action === 'delete') {
        if (confirm('¿Eliminar este usuario?')) {
          await eliminarUsuario(id);
          cargarUsuarios();
        }
      }
    });

    async function editarUsuario(id) {
      const res = await fetch('/api/usuarios/' + id, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) {
        alert('Error al obtener el usuario');
        return;
      }
      const u = await res.json();
      inputId.value = u.id;
      inputNombre.value = u.nombre;
      inputEmail.value = u.email;
      selectRol.value = u.rol || 'USER';
      selectEstado.value = u.estado || 'activo';
      inputPassword.value = ''; 
      formTitle.textContent = 'Editar Usuario (ID ' + u.id + ')';
    }

    async function eliminarUsuario(id) {
      const res = await fetch('/api/usuarios/' + id, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert('Error al eliminar: ' + (data.error || res.statusText));
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = inputId.value;

      const payload = {
        nombre: inputNombre.value,
        email: inputEmail.value,
        rol: selectRol.value,
        estado: selectEstado.value
      };

      if (inputPassword.value && inputPassword.value.trim() !== '') {
        payload.password = inputPassword.value;
      }

      const url = id ? '/api/usuarios/' + id : '/api/usuarios';
      const method = id ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        alert('Error al guardar: ' + (data.error || res.statusText));
      } else {
        alert('Guardado correctamente');
        limpiarFormulario();
        cargarUsuarios();
      }
    });

    function limpiarFormulario() {
      inputId.value = '';
      inputNombre.value = '';
      inputEmail.value = '';
      selectRol.value = 'USER';
      selectEstado.value = 'activo';
      inputPassword.value = '';
      formTitle.textContent = 'Crear / Editar Usuario';
    }

    btnCancelar.addEventListener('click', () => {
      limpiarFormulario();
    });

    cargarUsuarios();
  </script>
</body>
</html>
